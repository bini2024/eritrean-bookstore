<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Erishipping Surprise</title>
  <meta name="description" content="Discover and purchase curated surprise packages and books.">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    /* CSS is unchanged from the previous version, so it is omitted here for brevity */
    /* You can keep your existing CSS styles */
    :root {
      --primary: #0044cc; --secondary: #0066ff; --accent: #ffdd00; --bg: #f9f9f9; --text: #333; --card-bg: #fff; --panel-width: 320px; --error-color: #d9534f; --success-color: #5cb85c; --info-color: #5bc0de;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; line-height: 1.6;}
    img { max-width: 100%; height: auto; display: block;}
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    header { background: var(--primary); color: #fff; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    header h1 { font-size: 1.5rem; margin: 0; }
    header nav ul { list-style: none; display: flex; gap: 1.5rem; align-items: center; }
    header nav ul li a, header nav ul li button { color: #fff; text-decoration: none; font-weight: bold; cursor: pointer; background: none; border: none; font-size: 1rem; font-family: inherit; transition: opacity 0.2s ease-in-out; }
    header nav ul li a:hover, header nav ul li button:hover { opacity: 0.8; }
    header nav ul li button { display: flex; align-items: center; gap: 5px; }
    .cart-button-wrapper { position: relative; display: inline-block; }
    .cart-count { position: absolute; top: -8px; right: -12px; background: var(--accent); color: var(--primary); border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; font-weight: bold; min-width: 20px; text-align: center; line-height: 1.2; }
    .hero { background: url('https://via.placeholder.com/1200x600?text=Erishipping+Surprise') no-repeat center/cover; background-color: #555; height: 60vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white; position: relative; padding: 1rem; }
    .hero::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 0; }
    .hero > * { z-index: 1; }
    .hero h2 { font-size: 2.5rem; margin-bottom: 1.5rem; }
    .hero .cta .btn { background: var(--accent); color: var(--primary); border: none; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; transition: background 0.3s ease-in-out; font-size: 1.1rem; font-weight: bold;}
    .hero .cta .btn:hover { background: #ffe066; }
    .books-section { padding: 2rem 1rem; max-width: 1200px; margin: auto; }
    #booksError { color: var(--error-color); text-align: center; margin-bottom: 1rem; font-weight: bold; }
    .books-header { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    .books-header h2 { font-size: 2rem; color: var(--primary); }
    .books-header input { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid #ccc; border-radius: 25px; font-size: 1rem; }
    .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 1.5rem; }
    .books-grid p { text-align: center; grid-column: 1 / -1; }
    .book-card { background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; cursor: pointer; }
    .book-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .book-card img { width: 100%; height: 250px; object-fit: cover; object-position: center; background-color: #eee; }
    .book-info { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .book-info h3 { font-size: 1.1rem; color: var(--primary); margin-bottom: 0.5rem; line-height: 1.3;}
    .book-info p { margin-bottom: 0.5rem; font-size: 0.9rem;}
    .book-info .controls { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.8rem; }
    .book-info .qty { width: 60px; padding: 0.4rem; text-align: center; border: 1px solid #ccc; border-radius: 5px; font-size: 0.9rem; }
    .book-info .add-btn { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; flex-shrink: 0; transition: background 0.3s ease-in-out; font-size: 0.9rem;}
    .book-info .add-btn:hover:not(:disabled) { background: var(--secondary); }
    .book-info .add-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
    .cart-panel { position: fixed; top: 0; right: calc(-1 * var(--panel-width) - 10px); width: var(--panel-width); max-width: 95vw; height: 100%; background: var(--card-bg); box-shadow: -4px 0 12px rgba(0,0,0,0.3); transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; display: flex; flex-direction: column; }
    .cart-panel.open { right: 0; }
    .cart-header { padding: 1rem; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .cart-header h2 { margin: 0; font-size: 1.3rem; }
    .cart-close { background: transparent; border: none; color: white; font-size: 1.75rem; cursor: pointer; line-height: 1; padding: 0 0.5rem; transition: opacity 0.2s ease-in-out;}
    .cart-close:hover { opacity: 0.7;}
    .cart-content { flex-grow: 1; overflow-y: auto; padding: 1rem; -webkit-overflow-scrolling: touch; }
    .cart-content p { text-align: center; color: #666;}
    .cart-item { display: flex; align-items: center; margin-bottom: 1rem; gap: 0.8rem; border-bottom: 1px solid #eee; padding-bottom: 0.75rem; flex-wrap: wrap; }
    .cart-item img { flex-shrink: 0; width: 50px; height: 60px; object-fit: cover; border-radius: 4px;}
    .cart-item .item-info { flex-grow: 1; font-size: 0.95rem; margin-right: 0.5rem; }
    .cart-item .item-info strong { display: block; margin-bottom: 0.25rem; font-size: 1rem; color: var(--primary);}
    .cart-item .item-controls { display: flex; align-items: center; gap: 0.3rem; flex-shrink: 0; margin-top: 0.5rem; }
    .cart-item .item-controls button { background: #eee; border: 1px solid #ccc; padding: 0.3rem 0.6rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem; min-width: 30px; text-align: center; transition: background 0.2s;}
    .cart-item .item-controls button:hover:not(:disabled) { background: #ddd; }
    .cart-item .item-controls button:disabled { opacity: 0.5; cursor: not-allowed; }
    .cart-item .item-controls .remove-btn { background: #fdd; color: var(--error-color); border-color: var(--error-color); font-weight: bold;}
    .cart-item .item-controls .remove-btn:hover { background: #fcc; }
    .cart-item .item-qty { padding: 0 0.5rem; font-weight: bold; min-width: 25px; text-align: center; font-size: 1rem;}
    .cart-footer { padding: 1rem; border-top: 1px solid #ddd; flex-shrink: 0; background: #fff; }
    .cart-footer p { margin-bottom: 1rem; font-weight: bold; font-size: 1.1rem; }
    .cart-footer .checkout-btn { width: 100%; padding: 0.75rem; font-size: 1.1rem; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s ease-in-out; font-weight: bold; }
    .cart-footer .checkout-btn:hover:not(:disabled) { background: var(--secondary); }
    .cart-footer .checkout-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
    #checkout-status { margin-top: 1rem; font-weight: bold; text-align: center;}
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out; z-index: 1500; }
    .overlay.show { opacity: 1; visibility: visible; }
    a:focus, button:focus, input:focus { outline: none; box-shadow: 0 0 0 3px var(--secondary); border-color: var(--secondary); }
    .footer { background-color: #111; color: #ddd; padding: 25px 15px; font-family: Arial, sans-serif; margin-top: 3rem; }
    .footer-container { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 30px; max-width: 1000px; margin: auto; }
    .footer-col { flex: 1 1 220px; }
    .footer-col h4 { color: #fff; margin-bottom: 12px; font-size: 17px; border-bottom: 1px solid #444; padding-bottom: 5px;}
    .footer-col p, .footer-col ul, .footer-col a { color: #bbb; font-size: 14px; text-decoration: none; line-height: 1.6; }
    .footer-col ul { list-style: none; padding: 0; }
    .footer-col ul li { margin-bottom: 8px; }
    .footer-col a:hover { color: #fff; text-decoration: underline; }
    .social-icons a { font-size: 18px; margin-right: 10px; color: #bbb; transition: color 0.2s;}
    .social-icons a:hover { color: #fff; }
    .footer-bottom { text-align: center; margin-top: 25px; border-top: 1px solid #333; padding-top: 15px; font-size: 13px; color: #999; }
    .footer-bottom strong { color: #fff; }
  </style>
</head>
<body>
  <header>
    <h1>Erishipping Surprise</h1>
    <nav>
      <ul>
        <li><a href="#books">Products</a></li>
        <li class="cart-button-wrapper">
          <button type="button" id="cartToggleButton" aria-label="Toggle shopping cart">
            <i class="fas fa-shopping-cart"></i> Cart
            <span class="cart-count" id="cart-count" aria-live="polite">0</span>
          </button>
        </li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="hero">
      <h2>Your Next Favorite Surprise, Delivered</h2>
      <div class="cta"><button class="btn" onclick="scrollToElement('books')">Shop Now</button></div>
    </div>

    <section id="books" class="books-section">
      <div class="books-header">
        <h2>Our Collection</h2>
        <input type="search" id="searchInput" placeholder="Search products by title...">
      </div>
      <div id="booksError"></div>
      <div class="books-grid" id="booksGrid">
              <p>Loading products...</p>
      </div>
    </section>
  </main>

  <div class="overlay" id="cartOverlay"></div>
  <aside class="cart-panel" id="cartPanel" aria-labelledby="cartHeading">
    <div class="cart-header">
      <h2 id="cartHeading">Your Cart</h2>
      <button class="cart-close" id="cartCloseButton" aria-label="Close cart">&times;</button>
    </div>
    <div class="cart-content" id="cartItems">
          <p>Your cart is empty.</p>
    </div>
    <div class="cart-footer">
      <p>Total: $<span id="cartTotal">0.00</span></p>
      
      <button class="checkout-btn" id="checkoutBtn" disabled>
        Proceed to Checkout
      </button>
      
      <p id="checkout-status"></p>
    </div>
</aside>

  <footer class="footer">
    </footer>

  <script>
// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyBE3_ivAE2WFXQ3H8m1OWqM9APvRrI-Ac0", // Replace with your actual API Key
    authDomain: "eritrean-bookstore.firebaseapp.com",
    projectId: "eritrean-bookstore",
    storageBucket: "eritrean-bookstore.appspot.com",
    messagingSenderId: "645911365846",
    appId: "1:645911365846:web:5cd71799c6969bcaa1a177"
};

// --- Initialize Firebase & Stripe ---
let app, db, functions, stripe;
try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    // ADDED: Initialize Firebase Functions
    functions = firebase.functions();

    // ADDED: Initialize Stripe.js with your PUBLISHABLE key
    stripe = Stripe("pk_test_YOUR_STRIPE_PUBLISHABLE_KEY");

} catch (error) {
    console.error("CRITICAL: Initialization Error:", error);
    document.body.innerHTML = `<p style="color: red; padding: 20px;"><b>Application Initialization Failed.</b></p>`;
}

// --- Constants ---
const BOOKS_COLLECTION = 'books';
const DEBOUNCE_DELAY = 300;

// --- Global State ---
let allBooks = [];
let cart = Array.isArray(JSON.parse(localStorage.getItem('cart'))) ? JSON.parse(localStorage.getItem('cart')) : [];
let searchTimeout;

// --- DOM Element Caching ---
let booksGrid, searchInput, cartPanel, cartOverlay, cartItemsContainer, cartTotalEl, cartCountEl, checkoutBtn, checkoutStatusEl, cartToggleButton, cartCloseButton, booksErrorEl;

function cacheDOMElements() {
    booksGrid = document.getElementById('booksGrid');
    searchInput = document.getElementById('searchInput');
    cartPanel = document.getElementById('cartPanel');
    cartOverlay = document.getElementById('cartOverlay');
    cartItemsContainer = document.getElementById('cartItems');
    cartTotalEl = document.getElementById('cartTotal');
    cartCountEl = document.getElementById('cart-count');
    checkoutBtn = document.getElementById('checkoutBtn');
    checkoutStatusEl = document.getElementById('checkout-status');
    cartToggleButton = document.getElementById('cartToggleButton');
    cartCloseButton = document.getElementById('cartCloseButton');
    booksErrorEl = document.getElementById('booksError');
}

// --- Main Checkout Logic ---
async function handleCheckout() {
    if (cart.length === 0) {
        alert("Your cart is empty.");
        return;
    }
    
    // Disable button and show status
    checkoutBtn.disabled = true;
    checkoutStatusEl.textContent = "Processing...";
    checkoutStatusEl.style.color = "var(--info-color)";

    try {
        // Prepare cart data (send only what's necessary)
        const cartData = cart.map(item => ({
            id: item.id,
            quantity: item.quantity
        }));

        // Call the Firebase Cloud Function
        const createCheckoutSession = functions.httpsCallable('createCheckoutSession');
        const result = await createCheckoutSession({ cart: cartData });

        // Get the session ID from the function's response
        const sessionId = result.data.id;
        
        // Redirect to Stripe Checkout
        const { error } = await stripe.redirectToCheckout({
            sessionId: sessionId,
        });

        // If redirectToCheckout fails (e.g., network error), handle it
        if (error) {
            console.error("Stripe redirect failed:", error);
            checkoutStatusEl.textContent = `Error: ${error.message}`;
            checkoutStatusEl.style.color = "var(--error-color)";
            checkoutBtn.disabled = false;
        }
    } catch (error) {
        console.error("Error calling Cloud Function:", error);
        checkoutStatusEl.textContent = "An error occurred. Please try again.";
        checkoutStatusEl.style.color = "var(--error-color)";
        checkoutBtn.disabled = false;
    }
}

// --- Utility & Cart Functions (Mostly Unchanged) ---
// (The helper functions like toggleCart, saveCart, fetchBooks, renderBooks, addToCart, renderCart etc. remain the same as the previous versions)
function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    if(checkoutBtn) checkoutBtn.disabled = cart.length === 0;
}
function updateCartCount() { /* ... unchanged ... */ }
function toggleCart() { /* ... unchanged ... */ }
function fetchBooks() { /* ... unchanged ... */ }
function renderBooks(bookList) { /* ... unchanged ... */ }
function handleSearch() { /* ... unchanged ... */ }
function addToCart(bookId, quantityToAdd) { /* ... unchanged ... */ }
function renderCart() { /* ... unchanged ... */ }
function updateCartItemQuantity(bookId, change) { /* ... unchanged ... */ }
function removeFromCart(bookId) { /* ... unchanged ... */ }
function scrollToElement(id) { /* ... unchanged ... */ }
function escapeHTML(str) { /* ... unchanged ... */ }
function debounce(func, delay) { /* ... unchanged ... */ }

// --- Event Listeners Setup ---
function setupEventListeners() {
    searchInput.addEventListener('input', () => debounce(handleSearch, DEBOUNCE_DELAY));

    booksGrid.addEventListener('click', (e) => {
        if (e.target.classList.contains('add-btn')) {
            const button = e.target;
            const bookId = button.dataset.bookId;
            const card = button.closest('.book-card');
            const qtyInput = card.querySelector('.qty');
            if (bookId && qtyInput) {
                addToCart(bookId, parseInt(qtyInput.value, 10));
            }
        }
    });

    cartToggleButton.addEventListener('click', toggleCart);
    cartCloseButton.addEventListener('click', toggleCart);
    cartOverlay.addEventListener('click', toggleCart);

    cartItemsContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('qty-btn')) {
            const bookId = target.dataset.id;
            const change = parseInt(target.dataset.change, 10);
            updateCartItemQuantity(bookId, change);
        } else if (target.classList.contains('remove-btn')) {
            const bookId = target.dataset.id;
            removeFromCart(bookId);
        }
    });
    
    // ADDED: Event listener for the new checkout button
    checkoutBtn.addEventListener('click', handleCheckout);
}

// --- Application Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    cacheDOMElements();
    if (db && stripe && functions) {
        fetchBooks();
        setupEventListeners();
        updateCartCount();
        if(checkoutBtn) checkoutBtn.disabled = cart.length === 0;
    }
});
  </script>
</body>
</html>
