<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eritrean Bookstore</title>
  <meta name="description" content="Discover and purchase the best Eritrean literature online.">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <style>
    :root {
      --primary: #0044cc;
      --secondary: #0066ff;
      --accent: #ffdd00;
      --bg: #f9f9f9;
      --text: #333;
      --card-bg: #fff;
      --panel-width: 320px;
      --error-color: #d9534f;
      --success-color: #5cb85c;
      --info-color: #5bc0de;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h1 { font-size: 1.5rem; }
    header nav ul { list-style: none; display: flex; gap: 1rem; align-items: center; }
    header nav ul li a, header nav ul li button {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 1rem; /* Match link style */
      font-family: inherit; /* Match link style */
    }
    .cart-button-wrapper { /* Renamed from cart-button for clarity */
      position: relative;
      display: inline-block;
    }
    .cart-count {
      position: absolute;
      top: -8px;
      right: -12px;
      background: var(--accent);
      color: var(--primary);
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    .hero {
      /* Update this URL to your hero image */
      background: url('https://via.placeholder.com/1200x600?text=Eritrean+Bookstore+Hero') no-repeat center/cover;
      background-color: #555; /* Fallback color */
      height: 60vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      position: relative;
    }
    .hero::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.4); }
    .hero h2 { font-size: 2.5rem; z-index: 1; margin-bottom: 1rem; }
    .hero .cta .btn { background: var(--accent); color: var(--primary); border: none; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; transition: background 0.3s; z-index:1; font-size: 1rem; font-weight: bold;}
    .hero .cta .btn:hover { background: #ffe066; }

    .books-section { padding: 2rem 1rem; max-width: 1200px; margin: auto; }
    #booksError { color: var(--error-color); text-align: center; margin-bottom: 1rem; font-weight: bold; }
    .books-header { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    .books-header h2 { font-size: 2rem; color: var(--primary); }
    .books-header input { width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; }

    .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 1.5rem; }
    .book-card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s;
    }
    .book-card:hover { transform: translateY(-5px); }
     /* Added object-position for consistent look if images vary */
    .book-card img { width: 100%; height: 250px; object-fit: cover; object-position: center; background-color: #eee; /* Placeholder bg */ }
    .book-info { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .book-info h3 { font-size: 1.1rem; color: var(--primary); margin-bottom: 0.5rem; }
    .book-info p { margin-bottom: 0.5rem; }
    .book-info .controls { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
    .book-info .qty { width: 60px; padding: 0.35rem; text-align: center; border: 1px solid #ccc; border-radius: 5px; }
    .book-info .add-btn { background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: 5px; cursor: pointer; flex-shrink: 0; transition: background 0.3s; }
    .book-info .add-btn:disabled { background: #ccc; cursor: not-allowed; }

    /* Cart panel */
    .cart-panel {
      position: fixed;
      top: 0;
      right: calc(-1 * var(--panel-width) - 10px); /* Hide fully */
      width: var(--panel-width);
      max-width: 90vw; /* Prevent excessive width on small screens */
      height: 100%;
      background: var(--card-bg);
      box-shadow: -4px 0 8px rgba(0,0,0,0.2);
      transition: right 0.3s ease-in-out;
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }
    .cart-panel.open { right: 0; }
    .cart-header { padding: 1rem; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .cart-header h2 { margin: 0; font-size: 1.25rem; }
    .cart-close { background: transparent; border: none; color: white; font-size: 1.75rem; cursor: pointer; line-height: 1; padding: 0 0.5rem;}
    .cart-content { flex-grow: 1; overflow-y: auto; padding: 1rem; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.75rem; }
    .cart-item .item-info { flex-grow: 1; font-size: 0.9rem;}
    .cart-item .item-info strong { display: block; margin-bottom: 0.25rem; font-size: 1rem;}
    .cart-item .item-controls { display: flex; align-items: center; gap: 0.3rem; flex-shrink: 0;}
    .cart-item .item-controls button { background: #eee; border: 1px solid #ccc; padding: 0.25rem 0.5rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem; min-width: 25px; text-align: center; }
    .cart-item .item-controls .remove-btn { background: #fdd; color: var(--error-color); border-color: var(--error-color);}
    .cart-item .item-qty { padding: 0 0.5rem; font-weight: bold; min-width: 20px; text-align: center; }

    .cart-footer { padding: 1rem; border-top: 1px solid #ddd; flex-shrink: 0; }
    .cart-footer p { margin-bottom: 1rem; font-weight: bold; font-size: 1.1rem; }
    .cart-footer .checkout-btn { width: 100%; padding: 0.75rem; font-size: 1rem; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    .cart-footer .checkout-btn:hover { background: var(--secondary); }
    .cart-footer .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }
    #orderStatus { margin-top: 1rem; font-weight: bold; }
    #orderStatus.success { color: var(--success-color); }
    #orderStatus.error { color: var(--error-color); }
     #orderStatus.info { color: var(--info-color); } /* Style for processing status */


    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1500;
    }
    .overlay.show { opacity: 1; visibility: visible; }

    /* Focus Styles for Accessibility */
    a:focus, button:focus, input:focus {
      outline: 2px solid var(--secondary);
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.3); /* Optional softer glow */
    }
    /* Remove default outline if custom is applied */
    a, button, input { outline: none; }


    @media (max-width: 600px) {
      header h1 { font-size: 1.2rem; }
      .hero h2 { font-size: 2rem; }
      .books-grid { grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); }
      .book-card img { height: 200px; }
      /* Consider making cart panel full width or wider on small screens */
      /* .cart-panel { width: 90vw; --panel-width: 90vw; } */
    }

  .footer {
    background-color: #111;
    color: #ddd;
    padding: 20px 15px;
    font-family: Arial, sans-serif;
    margin-top: 3rem; /* Ensure space above footer */
  }
  .footer-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 20px;
    max-width: 1000px;
    margin: auto;
  }
  .footer-col { flex: 1 1 200px; }
  .footer-col h4 { color: #fff; margin-bottom: 10px; font-size: 16px; }
  .footer-col p, .footer-col ul, .footer-col a { color: #bbb; font-size: 13px; text-decoration: none; line-height: 1.4; }
  .footer-col ul { list-style: none; padding: 0; }
  .footer-col ul li { margin-bottom: 6px; }
  .footer-col a:hover { color: #fff; }
  .social-icons a { font-size: 16px; margin-right: 8px; color: #bbb; }
  .social-icons a:hover { color: #fff; }
  .footer-bottom { text-align: center; margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; font-size: 12px; color: #999; }

  </style>
</head>
<body>
  <header>
    <h1>Eritrean Bookstore</h1>
    <nav>
      <ul>
        <li><a href="#books">Books</a></li>
        <li class="cart-button-wrapper">
          <button type="button" id="cartToggleButton" aria-label="Toggle shopping cart">
              Cart
              <span class="cart-count" id="cart-count" aria-live="polite">0</span>
          </button>
        </li>
      </ul>
    </nav>
  </header>

  <div class="hero">
    <h2>Discover the Best Eritrean Books</h2>
    <div class="cta"><button class="btn" onclick="scrollToElement('books')">Shop Now</button></div>
  </div>

  <section id="books" class="books-section">
    <div class="books-header">
      <h2>Our Collection</h2>
      <input type="search" id="searchInput" placeholder="Search books by title...">
    </div>
    <div id="booksError"></div>
    <div class="books-grid" id="booksGrid">
        <p>Loading books...</p>
    </div>
  </section>

  <div class="overlay" id="cartOverlay"></div>
  <aside class="cart-panel" id="cartPanel" aria-labelledby="cartHeading">
    <div class="cart-header">
      <h2 id="cartHeading">Your Cart</h2>
      <button class="cart-close" id="cartCloseButton" aria-label="Close cart">&times;</button>
    </div>
    <div class="cart-content" id="cartItems">
        <p>Your cart is empty.</p>
    </div>
    <div class="cart-footer">
      <p>Total: $<span id="cartTotal">0.00</span></p>
      <button class="checkout-btn" id="checkoutBtn">Checkout</button>
      <p id="orderStatus"></p>
    </div>
  </aside>

  <footer class="footer">
    <div class="footer-container">
      <div class="footer-col about">
        <h4>About Eritrean Bookstore</h4>
        <p>We curate Eritrea’s finest literary works—celebrating culture, history, and heritage through timeless books and stories.</p>
      </div>
      <div class="footer-col links">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="#books">Browse Books</a></li>
          <li><a href="#contact">Contact Us</a></li>
          <li><a href="admin.html">Admin Panel</a></li>
        </ul>
      </div>
      <div class="footer-col contact" id="contact">
        <h4>Connect With Us</h4>
        <p>Email: <a href="mailto:contact@eritreanbookstore.com">contact@eritreanbookstore.com</a></p>
        <div class="social-icons">
          <a href="#" aria-label="Facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
          <a href="#" aria-label="Twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
          <a href="#" aria-label="Instagram" title="Instagram"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
       <p>&copy; <span id="currentYear">2025</span> <strong>Eritrean Bookstore</strong>. All rights reserved.</p>
    </div>
  </footer>

<script>
    // --- Firebase Configuration (Using your provided details) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBE3_ivAE2WFXQ3H8m1OWqM9APvRrI-Ac0",
      authDomain: "eritrean-bookstore.firebaseapp.com",
      projectId: "eritrean-bookstore",
      // Corrected default storage bucket format (usually appspot.com)
      storageBucket: "eritrean-bookstore.appspot.com",
      messagingSenderId: "645911365846",
      appId: "1:645911365846:web:5cd71799c6969bcaa1a177"
    };

    // --- Initialize Firebase (v8 Compat SDKs are expected) ---
    // Make sure you have included the necessary v8 compat scripts in the <head>:
    // firebase-app-compat.js, firebase-firestore-compat.js, firebase-functions-compat.js
    // If implementing customer login, also include firebase-auth-compat.js

    try {
        // Check if firebase object exists, indicating SDKs are loaded
        if (typeof firebase === 'undefined' || typeof firebase.initializeApp !== 'function') {
             throw new Error("Firebase SDK not loaded. Ensure scripts are in <head>.");
        }

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Use v8 syntax
        const functions = firebase.functions(); // Use v8 syntax for Cloud Functions

        // If you are using a region other than default (us-central1), set it like this:
        // functions.useFunctionsEmulator('http://localhost:5001'); // For local testing
        // functions.region('YOUR_REGION'); // Replace 'YOUR_REGION' like 'asia-northeast1'


        // --- Constants ---
        const BOOKS_COLLECTION = 'books';
        const ORDERS_COLLECTION = 'orders';
        const ORDER_STATUS_PENDING = 'pending'; // Note: This constant is not currently used in handleCheckout/processOrder logic provided
        const DEBOUNCE_DELAY = 300; // ms for search debounce

        // --- Global State ---
        let allBooks = [];
        // Initialize cart from local storage, ensure it's an array
        let cart = Array.isArray(JSON.parse(localStorage.getItem('cart'))) ? JSON.parse(localStorage.getItem('cart')) : [];

        let searchTimeout;

        // --- DOM Element Caching ---
        const booksGrid = document.getElementById('booksGrid');
        const searchInput = document.getElementById('searchInput');
        const cartPanel = document.getElementById('cartPanel');
        const cartOverlay = document.getElementById('cartOverlay');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartTotalEl = document.getElementById('cartTotal');
        const cartCountEl = document.getElementById('cart-count');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const orderStatusEl = document.getElementById('orderStatus');
        const cartToggleButton = document.getElementById('cartToggleButton');
        const cartCloseButton = document.getElementById('cartCloseButton');
        const booksErrorEl = document.getElementById('booksError');
        const currentYearEl = document.getElementById('currentYear');


        // --- Utility Functions ---
        function scrollToElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function toggleCart() {
          const isOpen = cartPanel.classList.contains('open');
          cartPanel.classList.toggle('open');
          cartOverlay.classList.toggle('show');
          if (!isOpen) {
              renderCart(); // Render cart content only when opening
          }
        }

        function saveCart() {
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartCount();
          // Disable checkout button if cart is empty
          checkoutBtn.disabled = cart.length === 0;
        }

        function updateCartCount() {
          // Ensure cart is an array before reducing
          const count = Array.isArray(cart) ? cart.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
          cartCountEl.textContent = count;
        }

        // Debounce function
        function debounce(func, delay) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(func, delay);
        }

         // Helper to prevent XSS
        function escapeHTML(str) {
            if (typeof str !== 'string') return str; // Return non-strings as is
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }


        // --- Core Application Logic ---

        // Fetch & Render Books
        async function fetchBooks() {
          booksErrorEl.textContent = '';
           // Display a loading message
          booksGrid.innerHTML = '<p>Loading books...</p>';
          try {
            // Fetch books, potentially add ordering later if needed
             const snapshot = await db.collection(BOOKS_COLLECTION).get(); // v8 get()

            if (snapshot.empty) {
                booksGrid.innerHTML = '<p>No books found in the collection.</p>';
                allBooks = [];
                return;
            }

            // v8 snapshot.docs mapping is the same
            allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderBooks(allBooks);

          } catch (error) {
            console.error("Error fetching books:", error);
            booksErrorEl.textContent = 'Failed to load books. Please check connection or Firestore configuration/rules.';
            booksGrid.innerHTML = ''; // Clear loading message on error
          }
        }

        function renderBooks(bookList) {
          booksGrid.innerHTML = ''; // Clear current grid content

          if (!Array.isArray(bookList)) {
              booksGrid.innerHTML = '<p>Error: Book data format incorrect.</p>';
              console.error("renderBooks received invalid data:", bookList);
              return;
          }


          if (bookList.length === 0 && searchInput.value.trim() !== '') {
               booksGrid.innerHTML = '<p>No books match your search.</p>';
          } else if (bookList.length === 0 && allBooks.length === 0 && booksErrorEl.textContent === '') {
               // Only show 'No books available' if the initial fetch was successful but returned no books
               booksGrid.innerHTML = '<p>No books available at the moment.</p>';
          } else if (bookList.length === 0 && allBooks.length > 0 && searchInput.value.trim() === '') {
              // This case should ideally not happen if allBooks is not empty and no search is active
               booksGrid.innerHTML = '<p>Error displaying books.</p>'; // Fallback message
          }
           else {
            bookList.forEach(book => {
              const card = document.createElement('div');
              card.className = 'book-card';
              // Ensure stock is a number, default to 0 if not valid
              const stock = typeof book.stock === 'number' ? book.stock : 0;
              const isOutOfStock = stock <= 0;
               // Ensure price is a number, default to 0 if not valid
              const price = typeof book.price === 'number' ? book.price : 0;


              card.innerHTML = `
                <img src="${book.imgURL || 'placeholder.jpg'}" alt="${escapeHTML(book.title || 'Untitled Book')}" loading="lazy">
                <div class="book-info">
                  <div>
                    <h3>${escapeHTML(book.title || 'Untitled Book')}</h3>
                    <p>$${price.toFixed(2)}</p>
                  </div>
                  <div class="controls">
                    <input type="number" min="1" max="${stock}" value="1" class="qty" id="qty-${book.id}" aria-label="Quantity for ${escapeHTML(book.title || 'Untitled Book')}" ${isOutOfStock ? 'disabled' : ''}>
                    <button class="add-btn" data-book-id="${book.id}" ${isOutOfStock ? 'disabled' : ''}>
                      ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                    </button>
                  </div>
                </div>`;

              const addButton = card.querySelector('.add-btn');
              if (addButton && !isOutOfStock) {
                  addButton.addEventListener('click', () => {
                      const qtyInput = card.querySelector(`#qty-${book.id}`);
                      // Ensure quantity is a valid positive integer
                      const quantity = parseInt(qtyInput.value, 10);
                      if (isNaN(quantity) || quantity < 1) {
                           alert('Please enter a valid quantity.');
                           qtyInput.value = '1'; // Reset input
                           return;
                      }
                      if (quantity > stock) {
                           alert(`Cannot add ${quantity}. Only ${stock} "${book.title}" available.`);
                            qtyInput.value = '1'; // Reset input
                           return;
                      }

                      addToCart(book.id, quantity);
                       // Provide visual feedback for adding to cart
                       addButton.textContent = 'Added!';
                       addButton.disabled = true; // Disable temporarily
                       setTimeout(() => {
                           addButton.textContent = 'Add to Cart';
                           addButton.disabled = false; // Re-enable
                           qtyInput.value = '1'; // Reset quantity input
                        }, 1000); // Show 'Added!' for 1 second

                  });
              }
              booksGrid.appendChild(card);
            });
          }
        }

        // Search functionality
        function handleSearch() {
            const query = searchInput.value.toLowerCase().trim();
            // Filter the globally stored allBooks array
            const filteredBooks = allBooks.filter(book =>
                book.title && typeof book.title === 'string' && book.title.toLowerCase().includes(query) // Ensure book.title exists and is string
            );
            renderBooks(filteredBooks);
        }

        // Cart Functions
        function addToCart(bookId, quantityToAdd) {
            const book = allBooks.find(b => b.id === bookId);
            // Validate book exists, has a valid price, and enough stock
            if (!book || typeof book.price !== 'number' || typeof book.stock !== 'number' || book.stock <= 0) {
                 console.error("Attempted to add invalid or out-of-stock book:", bookId, book);
                alert("Error: Could not add item. Book data is missing or out of stock.");
                return;
            }
             if (quantityToAdd < 1) {
                 console.warn("Attempted to add quantity less than 1:", quantityToAdd);
                 return;
             }

            const existingCartItemIndex = cart.findIndex(item => item.id === bookId);
            let currentCartQty = 0;

            if (existingCartItemIndex > -1) {
                currentCartQty = cart[existingCartItemIndex].quantity;
            }

            const potentialNewTotalQty = currentCartQty + quantityToAdd;

            // Check against current stock *in the database* (client-side check - subject to race conditions)
             // A truly secure check happens server-side during checkout
            if (book.stock < potentialNewTotalQty) {
                alert(`Sorry, only ${book.stock} "${book.title}" items available in total. You already have ${currentCartQty} in your cart.`);
                return;
            }

            if (existingCartItemIndex > -1) {
                cart[existingCartItemIndex].quantity = potentialNewTotalQty;
            } else {
                // Create a new item in the cart. Store necessary info.
                // The price stored here is for display/initial calc only.
                // This price MUST be re-verified server-side at checkout.
                cart.push({
                    id: bookId,
                    title: book.title,
                    price: book.price, // Store price here, BUT VALIDATE SERVER-SIDE at checkout
                    quantity: quantityToAdd,
                    imgURL: book.imgURL // Store image URL for cart display
                });
            }

            saveCart();
             // No need to renderCart here, it's rendered when the panel opens
        }

        function renderCart() {
            cartItemsContainer.innerHTML = ''; // Clear current cart content
            let currentTotal = 0;
            orderStatusEl.textContent = ''; // Clear previous order status message

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
                cartTotalEl.textContent = '0.00';
                checkoutBtn.disabled = true;
                return;
            }

            // Filter out potentially invalid items or items with quantity 0 just in case
            cart = cart.filter(item => item && item.id && typeof item.quantity === 'number' && item.quantity > 0);

            if (cart.length === 0) { // Re-check if filtering removed all items
                 cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
                cartTotalEl.textContent = '0.00';
                checkoutBtn.disabled = true;
                saveCart(); // Save the now empty cart
                return;
            }


            cart.forEach(item => {
                // Ensure price is a number before calculation
                const price = typeof item.price === 'number' ? item.price : 0;
                const itemTotal = price * item.quantity;
                currentTotal += itemTotal;
                // Find the book in the fetched list to check current stock (for warning display)
                 const bookInStock = allBooks.find(b => b.id === item.id)?.stock || 0;


                const div = document.createElement('div');
                div.className = 'cart-item';
                 // Use escapeHTML for title
                div.innerHTML = `
                   <img src="${item.imgURL || 'placeholder.jpg'}" alt="${escapeHTML(item.title || 'Item')}" style="width: 40px; height: auto; vertical-align: middle; margin-right: 8px; border-radius: 4px;">
                  <div class="item-info">
                    <strong>${escapeHTML(item.title || 'Untitled Item')}</strong>
                    <span>$${price.toFixed(2)} x ${item.quantity} = $${itemTotal.toFixed(2)}</span>
                    ${item.quantity > bookInStock ? `<br><small style="color:red; font-weight:bold;">Warning: Qty exceeds available stock (${bookInStock})</small>` : ''}
                  </div>
                  <div class="item-controls">
                    <button onclick="updateQty('${item.id}', ${item.quantity - 1})" aria-label="Decrease quantity of ${escapeHTML(item.title || 'item')}">-</button>
                    <span class="item-qty" aria-live="polite">${item.quantity}</span>
                     <button onclick="updateQty('${item.id}', ${item.quantity + 1})" ${item.quantity >= bookInStock ? 'disabled' : ''} aria-label="Increase quantity of ${escapeHTML(item.title || 'item')}">+</button>
                    <button class="remove-btn" onclick="removeItem('${item.id}')" aria-label="Remove ${escapeHTML(item.title || 'item')} from cart">&times;</button>
                  </div>`;
                cartItemsContainer.appendChild(div);
            });

            cartTotalEl.textContent = currentTotal.toFixed(2);
            checkoutBtn.disabled = false; // Re-enable if cart is not empty
        }

        function updateQty(id, newQty) {
            // Ensure newQty is a valid number
            newQty = parseInt(newQty, 10);
            if (isNaN(newQty) || newQty < 0) {
                 console.warn("Invalid new quantity:", newQty);
                 return;
            }

             // If new quantity is 0, just remove the item
            if (newQty === 0) {
                return removeItem(id);
            }

            const book = allBooks.find(b => b.id === id);
            const stock = book?.stock || 0; // Get current stock from the fetched list

             // Check against current stock
            if (newQty > stock) {
                alert(`Sorry, only ${stock} items available for "${book?.title || 'this item'}".`);
                return; // Prevent updating quantity above stock
            }

            cart = cart.map(item =>
                item.id === id ? { ...item, quantity: newQty } : item
            ); // Do not filter out quantity 0 here, let removeItem handle it

            saveCart();
            renderCart(); // Re-render cart after update
        }

        function removeItem(id) {
            cart = cart.filter(item => item.id !== id);
            saveCart();
            renderCart(); // Re-render cart after removal
        }

        // --- Secure Checkout Functionality (Client-Side Call to Cloud Function) ---
        async function handleCheckout() {
            if (cart.length === 0) {
                alert("Your cart is empty.");
                return;
            }

            // --- Client-Side Validation Before Calling Backend ---
            // This is a first line of defense, but server MUST re-validate everything.
            const itemsToProcess = [];
            let hasInvalidItems = false; // Flag to indicate if any invalid items were found

            for (const item of cart) {
                // Basic validation of cart item structure
                if (!item || !item.id || typeof item.quantity !== 'number' || item.quantity <= 0) {
                    // Found an invalid item. Alert user, log error, skip THIS item, but continue the loop.
                    alert(`Skipping invalid item in cart.`); // More specific alert
                    console.error("Invalid item found in cart during client-side validation:", item);
                    hasInvalidItems = true; // Mark that we found at least one invalid item
                    // FIX: Use continue instead of return
                    continue; // Skip the rest of the loop iteration for this item
                }
                // Only send bookId and quantity to the backend for security
                itemsToProcess.push({
                    bookId: item.id,
                    quantity: item.quantity
                });
            }

            // ADDED CLIENT-SIDE CONSOLE LOG FOR DEBUGGING
            console.log("Data being sent to processOrder function:", itemsToProcess);
            // END ADDITION


            // After checking all items in the cart...
            if (itemsToProcess.length === 0) {
                // This happens if the original cart was empty, or if ALL items were invalid.
                let message = "Your cart is empty.";
                if (hasInvalidItems) {
                     message = "Your cart contains no valid items to checkout."; // More specific if items were skipped
                }
                alert(message);
                orderStatusEl.textContent = message; // Update status message
                orderStatusEl.className = 'error'; // Use error style if no valid items
                renderCart(); // Re-render in case invalid items were conceptually removed
                // Reset checkout button state if we are stopping here
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'Checkout';
                return; // Stop checkout process as there's nothing to send
            }

            // If we reached here, itemsToProcess has at least one valid item.
            // Proceed with calling the Cloud Function.

            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'Processing Order...';
            orderStatusEl.textContent = 'Processing your order...';
            orderStatusEl.className = 'info'; // Use info style for processing


            // Prepare data to send to the Cloud Function
            // Sending the standard { items: [...] } structure
            const orderData = {
                items: itemsToProcess
                // Add customer details here if you collect them on the client (but validate/trust server-side)
                // customerInfo: { name: '...', email: '...' }
                // Add payment method details if integrating payment gateway on client (e.g., Stripe PaymentMethod ID)
                // paymentMethodId: '...'
            };


            try {
                 // --- Call the Secure Cloud Function ---
                 // Replace 'processOrder' with the actual name of your deployed Cloud Function
                 // Make sure your Cloud Function is deployed and callable!
                 const processOrderFunction = functions.httpsCallable('processOrder');

                 // Pass the order data to the Cloud Function
                 const result = await processOrderFunction(orderData);


                 // --- Handle the response from the Cloud Function ---
                 // Access the data via result.data
                 // Added robust check for result and result.data
                 const responseData = result && result.data ? result.data : null;


                 if (responseData && responseData.success) { // Check if responseData exists and has success property
                     // Order was processed securely server-side
                     cart = []; // Clear client-side cart
                     saveCart(); // Save empty cart to localStorage
                     renderCart(); // Update UI to show empty cart

                     orderStatusEl.textContent = responseData.message || 'Order placed successfully!';
                     orderStatusEl.className = 'success';

                     // Re-fetch book list to show updated stock (UI update)
                     fetchBooks(); // Triggers visual update of stock

                     // Optionally close the cart panel
                     // setTimeout(() => { toggleCart(); }, 2000);

                 } else {
                     // Handle cases where result.data is null/undefined OR success is false
                     orderStatusEl.textContent = (responseData && responseData.message) ? responseData.message : 'Order processing completed, but confirmation failed. Check Firestore.'; // More informative message
                     orderStatusEl.className = 'warning'; // Use warning if stock updated but response was bad
                     console.error("Cloud Function checkout completed, but response data unexpected:", responseData || "No response data received");
                      // Even on potential success (stock update), keep button disabled or show status clearly
                 }

            } catch (error) {
                // Handle errors during the Cloud Function call itself (e.g., network error, function not found, HttpsError)
                console.error("Error calling Cloud Function:", error);
                 // Firebase Functions HttpsErrors will be caught here
                 let errorMessage = 'An unexpected error occurred.';
                 if (error.code) {
                      // Use a more user-friendly message for the specific error
                     if (error.code === 'invalid-argument' && error.message.includes('Order must contain at least one item')) {
                         errorMessage = 'Checkout failed: Your cart is empty or invalid items were skipped.';
                     } else if (error.code === 'resource-exhausted' && error.message.includes('Insufficient stock')) {
                         errorMessage = 'Checkout failed: ' + error.message; // Use the specific insufficient stock message
                     } else {
                         // For other Firebase Errors, provide code and message
                         errorMessage += ` Code: ${error.code}.`;
                          if (error.message && !errorMessage.includes(error.message)) {
                                errorMessage += ` Message: ${error.message}.`;
                          }
                          errorMessage += ' Please see console.';
                     }
                 } else if (error.message) {
                     // For non-Firebase Error objects, just show the message
                      errorMessage = 'An error occurred: ' + error.message + '. Please see console.';
                 } else {
                      // Generic error message
                      errorMessage = 'An unexpected error occurred during checkout. Please see console.';
                 }


                orderStatusEl.textContent = errorMessage;
                orderStatusEl.className = 'error';

            } finally {
                 // Always re-enable button after attempt
                 checkoutBtn.disabled = false;
                 checkoutBtn.textContent = 'Checkout';
            }
        }

        // --- Event Listeners ---
        cartToggleButton.addEventListener('click', toggleCart);
        cartCloseButton.addEventListener('click', toggleCart);
        // Close cart also when clicking outside the panel
        cartOverlay.addEventListener('click', toggleCart);
        checkoutBtn.addEventListener('click', handleCheckout);

        // Add event listener for search input with debounce
        searchInput.addEventListener('input', () => {
            debounce(handleSearch, DEBOUNCE_DELAY);
        });

        // --- Initial Load ---
        if (currentYearEl) {
            currentYearEl.textContent = new Date().getFullYear(); // Update copyright year dynamically
        }
        updateCartCount(); // Load cart from local storage on page load and update count
        fetchBooks(); // Load books from Firestore on page load
        // checkoutBtn disabled state is handled by saveCart() call above

        // --- Make necessary functions globally available for inline HTML handlers ---
        // Note: Using addEventListener is generally preferred over inline handlers (onclick="...").
        // Keeping these for compatibility with your HTML structure.
        window.updateQty = updateQty;
        window.removeItem = removeItem;
        window.scrollToElement = scrollToElement; // Keep if hero button uses onclick
        // Add handleCheckout to window if it's ever called via onclick=handleCheckout()
        // window.handleCheckout = handleCheckout; // Uncomment if you use onclick="handleCheckout()" on the button

    } catch (initError) {
        // Catch potential errors during Firebase SDK initialization or script loading
        console.error("Firebase initialization failed:", initError);
         const errorMessage = 'Failed to initialize Firebase SDK. Ensure SDK scripts are in <head> and config is correct. Check console.';
         if(booksErrorEl) {
             booksErrorEl.textContent = errorMessage;
         }
         if(booksGrid) {
              booksGrid.innerHTML = ''; // Clear any loading message
         }
          if(checkoutBtn) {
             checkoutBtn.disabled = true; // Disable checkout if Firebase didn't initialize
          }
           if(cartToggleButton) {
             cartToggleButton.disabled = true; // Disable cart button if Firebase didn't initialize
           }
           if(searchInput) {
              searchInput.disabled = true; // Disable search if Firebase didn't initialize
           }
           // Prevent errors if cart panel elements are accessed before init
            if(cartItemsContainer) cartItemsContainer.innerHTML = '<p>Store not available.</p>';
            if(cartTotalEl) cartTotalEl.textContent = '0.00';
            if(cartCountEl) cartCountEl.textContent = '0';
             if(orderStatusEl) {
                 orderStatusEl.textContent = 'Store initialization failed.';
                 orderStatusEl.className = 'error';
             }


    } // End of Firebase try/catch


  </script>
</body>
</html>
